# 服务状态监控使用说明

## 📊 功能说明

监控脚本会自动每5分钟检查一次以下服务状态：
- ✅ API 服务 (http://localhost:3001)
- ✅ Web 服务 (http://localhost:3000)
- ✅ PostgreSQL 数据库
- ✅ Redis 缓存
- ✅ Docker 容器状态

## 🚀 使用方法

### 方式 1: 前台运行（推荐用于调试）

```bash
./scripts/monitor-status.sh
```

按 `Ctrl+C` 停止监控。

### 方式 2: 后台运行

```bash
# 启动后台监控
./scripts/monitor-status-background.sh

# 停止监控
./scripts/stop-monitor.sh
```

### 方式 3: 手动检查一次

```bash
# 设置间隔为0，只检查一次
INTERVAL=0 ./scripts/monitor-status.sh
```

## 📝 查看日志

### 实时查看日志
```bash
tail -f logs/monitor-$(date +%Y%m%d).log
```

### 查看今天的日志
```bash
cat logs/monitor-$(date +%Y%m%d).log
```

### 查看后台运行日志
```bash
tail -f logs/monitor-background.log
```

## ⚙️ 配置选项

可以通过环境变量自定义配置：

```bash
# 自定义 API URL
API_URL=http://localhost:3001 ./scripts/monitor-status.sh

# 自定义 Web URL
WEB_URL=http://localhost:3000 ./scripts/monitor-status.sh

# 自定义检查间隔（秒）
INTERVAL=60 ./scripts/monitor-status.sh  # 每1分钟检查一次

# 自定义日志目录
LOG_DIR=/var/log/hongbao ./scripts/monitor-status.sh
```

## 📊 状态说明

- ✅ **绿色**: 服务正常运行
- ⚠️ **黄色**: 服务未运行（非关键服务）
- ❌ **红色**: 服务未运行（关键服务）

## 🔍 检查内容

### API 服务检查
- HTTP 健康检查端点 (`/health`)
- 响应时间
- 返回状态

### 数据库检查
- Docker 容器状态
- 数据库连接（如果安装了 `psql`）

### Redis 检查
- Docker 容器状态
- Redis 连接（如果安装了 `redis-cli`）

### Docker 容器检查
- 容器运行状态
- 容器健康状态
- 端口映射

## 🛠️ 故障排查

### 如果监控脚本无法启动

1. 检查脚本权限：
```bash
chmod +x scripts/monitor-status.sh
```

2. 检查日志目录：
```bash
mkdir -p logs
```

### 如果服务显示未运行但实际在运行

1. 检查服务 URL 是否正确
2. 检查防火墙设置
3. 检查服务是否监听在正确的端口

### 如果 PostgreSQL 显示未运行

1. 检查 Docker 容器是否运行：
```bash
docker ps | grep postgres
```

2. 检查容器名称是否匹配（脚本会自动检测包含 "postgres" 的容器）

## 📈 监控数据

所有监控数据都会记录到日志文件中，包括：
- 检查时间戳
- 服务状态
- API 健康检查响应
- Docker 容器信息
- 错误和警告信息

## 🔄 自动重启

如果需要监控脚本在崩溃后自动重启，可以使用 `systemd` 或 `supervisor` 等进程管理工具。

### 使用 systemd (Linux)

创建 `/etc/systemd/system/hongbao-monitor.service`:

```ini
[Unit]
Description=HongBao Service Monitor
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/HongBao
ExecStart=/path/to/HongBao/scripts/monitor-status.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

然后：
```bash
sudo systemctl enable hongbao-monitor
sudo systemctl start hongbao-monitor
```

## 📞 告警通知

当前版本只记录日志，未来可以扩展支持：
- 邮件通知
- Slack/Discord Webhook
- 短信通知
- 企业微信/钉钉通知

