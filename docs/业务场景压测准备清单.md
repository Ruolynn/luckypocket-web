# 业务场景压力测试准备清单

> 目标：为“高并发创建/领取礼物”“Frame 领取”“Socket.IO 广播”等真实业务场景提供可重复的压测环境。

---

## 1. 基础设施
- [x] 新建独立的 `.env.loadtest`（已提供模板，位于 `apps/api/.env.loadtest`）
- [x] 使用 `scripts/load-test/setup-loadtest-env.sh` 启动 PostgreSQL/Redis 并执行迁移、种子
  ```bash
  ./scripts/load-test/setup-loadtest-env.sh
  ```
- [ ] 手动模式（如需细粒度控制）：
  ```bash
  docker compose up -d postgres redis
  pnpm --filter @luckypocket/api prisma migrate deploy --schema prisma/schema.prisma
  pnpm --filter @luckypocket/api prisma db seed
  ```
- [ ] 确认 Redis 无密码 / 或与 `.env.loadtest` 保持一致（详见 `ENV_SETUP.md`）
- [ ] 准备高可用 RPC（Alchemy / Infura，速率 ≥ 300 req/s）

## 2. 测试账户与数据

- [ ] 创建压力测试专用钱包 3~5 个（记录私钥，仅限本地）
- [ ] 申请 Sepolia 测试币 & 稳定币（USDC/USDT）
- [ ] 准备 ERC20 测试合约或复用现有 `TOKEN_WHITELIST`
- [ ] 生成礼物初始数据脚本（批量创建 50/100 个礼物）
- [ ] 预置 Frame 对应的 Farcaster FID / 钱包映射

## 3. 服务配置

- [ ] API：`DISABLE_RATE_LIMIT=true`，`ENABLE_FRAME_RATE_LIMIT=false`
- [ ] Web：构建产物（`pnpm --filter @luckypocket/web build`）并以 `pnpm start` 运行
- [ ] Socket.IO：确认 Redis adapter 使用独立 DB（`REDIS_URL`）
- [ ] 后台任务：`EVENT_SYNC_ENABLED=false`（可选，视测试需要）

## 4. 监控与日志

- [ ] 启用 `scripts/watch-status.sh` 监控 API / Web / DB / Redis
- [ ] 开启 Prisma Query Log（`.env.loadtest` 中 `PRISMA_LOG_LEVEL=info`）
- [ ] 准备 `k6` Summary Export 目录（`logs/`) 并清理旧文件
- [ ] 需要的话对接 Prometheus / Grafana（可参考 `docs/压力测试计划.md`）

## 5. 压测脚本与场景

| 场景 | 脚本 | 补充说明 |
|------|------|----------|
| API 只读 | `scripts/load-test/k6-api-test.js` | 已确认稳定，可作为基线 |
| WebSocket | `scripts/load-test/k6-websocket-test.js` | 已对接 Socket.IO 协议握手/心跳 |
| 创建礼物 | `scripts/load-test/k6-create-gift.js` *(待实现)* | 需要准备签名/Token 验证逻辑 |
| 领取礼物 | `scripts/load-test/k6-claim-gift.js` *(待实现)* | 涉及锁、幂等、链上代理 |
| Frame 领取 | `scripts/load-test/k6-frame-claim.js` *(待实现)* | 需预置 FID ↔ 钱包映射 |
| Socket 广播 | `scripts/load-test/k6-websocket-test.js` *(扩展场景)* | 模拟房间广播/消息风暴 |

> 建议从现有脚本复制骨架，复用 `helpers`、`auth`、`metrics` 公共模块。

## 6. 测试执行流程

1. **基线验证**：运行 API & WebSocket 压测，确认环境健康。
2. **数据装载**：执行批量创建礼物脚本，检查数据库与链上状态。
3. **业务压测**：分阶段执行（创建 → 领取 → Frame → 广播）。
4. **结果收集**：使用 `--summary-export` 与 `logs/` 目录存档输出。
5. **回滚清理**：重置 Redis / 数据库，删除测试数据。

## 7. 风险与备选方案

- RPC 速率受限 → 准备多个 API Key，或使用本地 Anvil 模拟器。  
- Prisma 链上数据同步不稳定 → 暂时关闭事件监听，仅测试 API 层。  
- Redis 连接瓶颈 → 调整连接池或启用本地 Redis Cluster。  
- Socket.IO 粘包/断线 → 调整 `PING_INTERVAL`、`PING_TIMEOUT`，或降低并发梯度。

---

**下一步**：按照清单逐项完成后，即可进入“创建/领取礼物”业务压测脚本的开发与执行阶段。
